<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>One Piece — Lista Manga</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#ffd166;--muted:#94a3b8;--glass:rgba(255,255,255,0.03)}
    *{box-sizing:border-box}
    body{font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; background:linear-gradient(180deg,#071023 0%, #081428 100%); color:#e6eef8}
    .wrap{max-width:920px;margin:36px auto;padding:20px}
    header{display:flex;align-items:center;gap:16px}
    h1{font-size:20px;margin:0}
    p.lead{margin:4px 0 16px;color:var(--muted)}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    input[type=text], input[type=email], input[type=password]{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:var(--glass);color:inherit}
    button{background:var(--accent);border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    /* Stato attivo per pulsante Nascondi comprati */
    button.ghost.active{ border-color:#22c55e; }
    .list{margin-top:12px;display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px}
    .item{display:flex;align-items:center;gap:8px;padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.02)}
    label{display:flex;gap:8px;align-items:center;cursor:pointer}
    .vol{font-weight:600}
    .muted{color:var(--muted);font-size:13px}
    footer{margin-top:14px;color:var(--muted);display:flex;justify-content:space-between;align-items:center}
    .small{font-size:13px}
    .search{width:220px}
    .hidden{display:none}
    @media (max-width:520px){.list{grid-template-columns:repeat(2,1fr)}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <svg width="44" height="44" viewBox="0 0 24 24" fill="none" style="flex-shrink:0"><rect width="24" height="24" rx="6" fill="#ffd166"/><path d="M6 18L10 6l4 12 4-12" stroke="#0b1220" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <div>
        <h1>Lista One Piece — Manga</h1>
      </div>
    </header>

    <div class="card" id="app">
      <!-- Barra autenticazione -->
      <div class="controls" id="authControls">
        <span class="small muted" id="authStatus">Non loggato</span>
        <input id="email" type="email" placeholder="Email">
        <input id="password" type="password" placeholder="Password">
        <button id="loginBtn" class="ghost">Login</button>
        <button id="logoutBtn" class="ghost hidden">Logout</button>
        <span class="small muted" id="userEmail"></span>
      </div>

      <div class="controls">
        <button id="hideBoughtBtn" class="ghost" aria-pressed="false">Nascondi comprati</button>
        <input id="search" class="search" type="text" placeholder="Cerca volume... (es. '5' o 'Vol. 12')">
        <input id="newTitle" type="text" placeholder="Aggiungi nuovo volume (es. Vol. 109 o One Piece 109)">
        <button id="addBtn">Aggiungi</button>
        <button id="resetBtn" class="ghost">Reset totale</button>
        <button id="exportBtn" class="ghost">Esporta JSON</button>
        <button id="importBtn" class="ghost">Importa JSON</button>
      </div>

      <div class="small muted">Totale volumi: <span id="total">0</span> · Comprati: <strong id="bought">0</strong></div>

      <div class="list" id="list"></div>

      <footer>
        <div class="muted">Sito ospitato su GitHub Pages</div>
      </footer>
    </div>
  </div>

  <script>
    // ==== CONFIGURAZIONE SUPABASE (usa le tue chiavi reali) ====
    const SUPABASE_URL = "https://mulnocojjsubalkazppb.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im11bG5vY29qanN1YmFsa2F6cHBiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2ODA0NDgsImV4cCI6MjA4MDI1NjQ0OH0.Bn5GWQrwoJ_XlGk1wWn0Y2G0emH-CpF_7G9TfhG60rs";
    const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // DOM references
    const listEl = document.getElementById('list');
    const totalEl = document.getElementById('total');
    const boughtEl = document.getElementById('bought');
    const searchEl = document.getElementById('search');
    const newTitleEl = document.getElementById('newTitle');
    const userEmailDisplay = document.getElementById('userEmail');
    const authStatus = document.getElementById('authStatus');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const hideBoughtBtn = document.getElementById('hideBoughtBtn');

    // App state
    let data = [];
    let hideBoughtState = false;

    // Helpers Supabase
    async function fetchData(){
      const { data: rows, error } = await client
        .from('manga')
        .select('id, title, bought, owner');
      if(error){
        throw error;
      }
      return rows || [];
    }

    async function saveItem(item){
      if(!item.id) return;
      const { error } = await client
        .from('manga')
        .update({ title: item.title, bought: !!item.bought })
        .eq('id', item.id);
      if(error) throw error;
    }

    async function addItem(title){
      const payload = { title, bought:false };
      if(window.currentUser && window.currentUser.email){
        payload.owner = window.currentUser.email;
      }
      const { data: inserted, error } = await client
        .from('manga')
        .insert([payload])
        .select();
      if(error) throw error;
      return inserted;
    }

    async function patchOrCreate(item){
      if(item.id){
        await saveItem(item);
      }else{
        await addItem(item.title);
      }
    }

    // Render
    function getVolNumber(title){
      const m = String(title||'').match(/\d+/);
      return m ? parseInt(m[0], 10) : null;
    }

    function volumeSort(a,b){
      const na = getVolNumber(a.title);
      const nb = getVolNumber(b.title);
      if(na != null && nb != null) return na - nb;
      if(na != null) return -1;
      if(nb != null) return 1;
      return (a.title||'').localeCompare(b.title||'');
    }

    function render(filterText=''){
      listEl.innerHTML = '';
      const hide = hideBoughtState;
      const filtered = data.filter(item => {
        const match = (item.title||'').toLowerCase().includes((filterText||'').toLowerCase());
        if(hide && item.bought) return false;
        return match;
      });
      filtered.sort(volumeSort);

      filtered.forEach(item => {
        const div = document.createElement('div'); div.className='item';
        const id = 'vol-'+(item.id || Math.random().toString(36).slice(2,8));
        const label = document.createElement('label'); label.htmlFor = id;
        const chk = document.createElement('input'); chk.type='checkbox'; chk.id=id; chk.checked = !!item.bought;
        if(!window.currentUser) chk.disabled = true;
        chk.addEventListener('change', async ()=>{
          item.bought = chk.checked;
          try{ await saveItem(item); }catch(e){ console.error(e); alert('Errore salvataggio remoto.'); }
          updateCounters();
        });
        const span = document.createElement('span'); span.className='vol'; span.textContent = item.title || ('Vol. '+item.id);
        label.appendChild(chk); label.appendChild(span);
        div.appendChild(label);
        listEl.appendChild(div);
      });

      totalEl.textContent = data.length;
      updateCounters();
    }

    function updateCounters(){
      const bought = data.reduce((s,i)=>s + (i.bought?1:0),0);
      boughtEl.textContent = bought;
    }

    // Actions
    async function addVolume(title){
      if(!title || !title.trim()) return;
      if(!window.currentUser){ alert('Effettua il login per aggiungere.'); return; }
      try{
        await addItem(title.trim());
        data = await fetchData();
        render(searchEl.value);
        newTitleEl.value=''; newTitleEl.focus();
      }catch(e){ console.error(e); alert('Errore aggiunta remoto: '+(e.message||e)); }
    }

    async function resetAll(){
      alert('Per un reset completo elimina i record della tabella "manga" su Supabase o svuota la tabella.');
    }

    function exportJSON(){
      const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='onepiece_manga_collection.json'; a.click(); URL.revokeObjectURL(url);
    }

    async function importJSON(){
      if(!window.currentUser){ alert('Effettua il login per importare.'); return; }
      const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
      inp.addEventListener('change', async e=>{
        const f = e.target.files[0]; if(!f) return;
        const reader = new FileReader(); reader.onload = async ev => {
          try{
            const parsed = JSON.parse(ev.target.result);
            if(!Array.isArray(parsed)) throw new Error('Il JSON deve essere un array.');
            for(const it of parsed){
              if(it && (it.id || it.title)){
                await patchOrCreate({ id: it.id, title: it.title, bought: !!it.bought });
              }
            }
            data = await fetchData();
            render(searchEl.value);
            alert('Importazione completata.');
          }catch(err){ alert('Import fallita: '+err.message); }
        };
        reader.readAsText(f);
      });
      inp.click();
    }

    // Auth handlers
    function refreshAuthUI(){
      const logged = !!window.currentUser;
      document.getElementById('email').classList.toggle('hidden', logged);
      document.getElementById('password').classList.toggle('hidden', logged);
      loginBtn.classList.toggle('hidden', logged);
      logoutBtn.classList.toggle('hidden', !logged);
      userEmailDisplay.textContent = logged ? (window.currentUser.email||'') : '';
      authStatus.textContent = logged ? 'Loggato' : 'Non loggato';
      // Disable write controls when logged out
      newTitleEl.disabled = !logged;
      document.getElementById('addBtn').disabled = !logged;
      document.getElementById('importBtn').disabled = !logged;
    }

    loginBtn.addEventListener('click', async ()=>{
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const { data: authData, error } = await client.auth.signInWithPassword({ email, password });
      if(error){ alert('Credenziali errate'); return; }
      window.currentUser = authData.user;
      refreshAuthUI();
      // refetch after login (RLS might allow more)
      try{ data = await fetchData(); render(searchEl.value); }catch(e){ console.error(e); }
    });

    logoutBtn.addEventListener('click', async ()=>{
      await client.auth.signOut();
      window.currentUser = null;
      refreshAuthUI();
      try{ data = await fetchData(); render(searchEl.value); }catch(e){ console.error(e); }
    });

    // Eventi UI
    document.getElementById('addBtn').addEventListener('click', ()=>addVolume(newTitleEl.value));
    document.getElementById('resetBtn').addEventListener('click', resetAll);
    document.getElementById('exportBtn').addEventListener('click', exportJSON);
    document.getElementById('importBtn').addEventListener('click', importJSON);
    newTitleEl.addEventListener('keydown', e=>{ if(e.key==='Enter') addVolume(newTitleEl.value); });
    hideBoughtBtn.addEventListener('click', ()=>{
      hideBoughtState = !hideBoughtState;
      hideBoughtBtn.classList.toggle('active', hideBoughtState);
      hideBoughtBtn.setAttribute('aria-pressed', hideBoughtState ? 'true' : 'false');
      render(searchEl.value);
    });
    searchEl.addEventListener('input', ()=>render(searchEl.value));

    // Init
    (async ()=>{
      const { data: sess } = await client.auth.getSession();
      if(sess && sess.session){
        window.currentUser = sess.session.user;
      }
      refreshAuthUI();
      try{
        data = await fetchData();
        // Seed iniziale solo se loggato e tabella vuota
        if(window.currentUser && (!data || data.length===0)){
          const seed = [];
          for(let i=1;i<=108;i++) seed.push({title: 'Vol. '+i, bought:false});
          for(const s of seed){ await addItem(s.title); }
          data = await fetchData();
        }
        render();
      }catch(e){
        console.error(e);
        alert('Impossibile contattare Supabase. Controlla SUPABASE_URL e SUPABASE_KEY nella configurazione.');
        data = [];
        render();
      }
    })();
  </script>
</body>
</html>
